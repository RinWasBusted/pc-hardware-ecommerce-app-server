// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  customer
  admin
}

model User {
  id          Int      @id @default(autoincrement())
  full_name   String
  email       String   @unique
  phone_number String?
  password    String
  google_id   String?  @unique
  role        Role     @default(customer)
  setting     Json?
  is_verified Boolean  @default(false)
  is_active   Boolean  @default(true)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  addresses   Addresses[]
  stock_logs   StockLogs[]
  carts carts?
  orders Orders[]
  order_status_logs OrderStatusLogs[]
  reviews Reviews[]
  wishlists Wishlists[]
  notifications Notifications[]
  return_requests ReturnRequests[]
}

model Addresses {
  id           Int      @id @default(autoincrement())
  user_id      Int
  recipient    String
  phone_number String
  province     String
  district     String
  ward         String
  street       String
  is_default   Boolean  @default(false)
  created_at   DateTime @default(now())

  orders Orders[]

  user         User     @relation(fields: [user_id], references: [id], onDelete: Cascade)
  @@index([user_id])
}

model Categories {
  id          Int      @id @default(autoincrement())
  name        String   
  slug       String   @unique
  description String?
  parent_id  Int?
  created_at  DateTime @default(now())

  children   Categories[] @relation("CategoryToSubcategories")
  parent     Categories? @relation("CategoryToSubcategories", fields: [parent_id], references: [id], onDelete: Cascade)
  products   Products[]
  @@index([parent_id])
}

model Brands {
  id Int @id @default(autoincrement())
  name String @unique
  logo_url String?
  created_at DateTime @default(now())

  products Products[]
}

enum ProductStatus {
  available
  out_of_stock
  discontinued
}

model Products {
  id Int @id @default(autoincrement())
  name String
  slug String @unique
  description String?
  category_id Int
  brand_id Int
  specifications Json
  status ProductStatus @default(available)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  product_variants ProductVariants[]
  product_images ProductImages[]
  reviews Reviews[]
  wishlists Wishlists[]

  category Categories @relation(fields: [category_id], references: [id])
  brand Brands @relation(fields: [brand_id], references: [id])
  @@index([category_id])
  @@index([brand_id])
}

model ProductVariants {
  id Int @id @default(autoincrement())
  product_id Int
  sku String @unique
  version String?
  color String?
  color_hex String?
  price Decimal
  compare_at_price Decimal?
  stock Int
  is_active Boolean @default(true)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  product_images ProductImages[]
  stock_logs StockLogs[]
  cart_items CartItems[]
  order_items OrderItems[]
  reviews Reviews[]

  product Products @relation(fields: [product_id], references: [id])
  @@index([product_id])
  @@unique([product_id, version, color])
}

model ProductImages {
  id Int @id @default(autoincrement())
  product_id Int 
  variant_id Int?
  image_url String
  is_primary Boolean @default(false)
  sort_order Int @default(0)

  product Products @relation(fields: [product_id], references: [id])
  variant ProductVariants? @relation(fields: [variant_id], references: [id])
  @@index([product_id])
  @@index([variant_id])
}

model StockLogs {
  id Int @id @default(autoincrement())
  variant_id Int
  admin_id Int
  change_qty Int
  note String?
  created_at DateTime @default(now())

  product_variant ProductVariants @relation(fields: [variant_id], references: [id])
  admin User @relation(fields: [admin_id], references: [id])
  @@index([variant_id])
  @@index([admin_id])
}

enum DiscountType {
  percent
  fixed
}

model Coupons {
  id Int @id @default(autoincrement())
  code String @unique
  discount_type DiscountType
  discount_value Decimal
  min_order_value Decimal?
  max_uses Int?
  used_count Int @default(0)
  expires_at DateTime?
  is_active Boolean @default(true)
  created_at DateTime @default(now())

  orders Orders[]
}

model carts {
  id Int @id @default(autoincrement())
  user_id Int @unique
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  cart_items CartItems[]

  user User @relation(fields: [user_id], references: [id])
  @@index([user_id])
}

model CartItems {
  id Int @id @default(autoincrement())
  cart_id Int
  variant_id Int
  quantity Int @default(1)
  added_at DateTime @default(now())

  @@unique([cart_id, variant_id])
  cart carts @relation(fields: [cart_id], references: [id])
  product_variant ProductVariants @relation(fields: [variant_id], references: [id])
  @@index([cart_id])
  @@index([variant_id])
}

enum PaymentMethod {
  cod
  momo
  bank_transfer
}

enum OrderPaymentStatus {
  unpaid
  paid
  refunded
}

enum OrderStatus {
  pending
  confirmed
  preparing
  packed
  shipping
  delivered
  failed
  cancelled
}

model Orders {
  id Int @id @default(autoincrement())
  user_id Int
  address_id Int
  coupon_id Int?
  subtotal Decimal
  discount_amount Decimal @default(0)
  shipping_fee Decimal  @default(0)
  total Decimal
  payment_method PaymentMethod
  payment_status OrderPaymentStatus @default(unpaid)
  order_status OrderStatus @default(pending)
  cancel_reason String?
  note String?
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  order_items OrderItems[]
  order_status_logs OrderStatusLogs[]
  payments Payments[]
  reviews Reviews[]
  return_requests ReturnRequests[]

  user User @relation(fields: [user_id], references: [id])
  address Addresses @relation(fields: [address_id], references: [id])
  coupon Coupons? @relation(fields: [coupon_id], references: [id])
  @@index([user_id])
  @@index([address_id])
  @@index([coupon_id])
}

model OrderItems {
  id Int @id @default(autoincrement())
  order_id Int
  variant_id Int
  quantity Int
  unit_price Decimal
  subtotal Decimal

  return_items ReturnItems[]

  order Orders @relation(fields: [order_id], references: [id])
  product_variant ProductVariants @relation(fields: [variant_id], references: [id])
  @@index([order_id])
  @@index([variant_id])
}

model OrderStatusLogs {
  id Int @id @default(autoincrement())
  order_id Int
  changed_by Int
  old_status OrderStatus
  new_status OrderStatus
  note String?
  changed_at DateTime @default(now())

  order Orders @relation(fields: [order_id], references: [id])
  admin User @relation(fields: [changed_by], references: [id])
  @@index([order_id])
  @@index([changed_by])
}

enum PaymentStatus {
  pending
  success
  failed
  refunded
}

model Payments {
  id Int @id @default(autoincrement())
  order_id Int 
  payment_method PaymentMethod
  amount Decimal
  transaction_id String?
  gateway_response Json?
  payment_status PaymentStatus @default(pending)
  paid_at DateTime?
  created_at DateTime @default(now())

  order Orders @relation(fields: [order_id], references: [id])
  @@index([order_id])
}

model Reviews {
  id Int @id @default(autoincrement())
  user_id Int
  product_id Int
  variant_id Int
  order_id Int
  rating Int
  comment String?
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  user User @relation(fields: [user_id], references: [id])
  product Products @relation(fields: [product_id], references: [id])
  variant ProductVariants @relation(fields: [variant_id], references: [id])
  order Orders @relation(fields: [order_id], references: [id])
  @@index([user_id])
  @@index([product_id])
  @@index([variant_id])
  @@index([order_id])
}

model Wishlists {
  id Int @id @default(autoincrement())
  user_id Int
  product_id Int
  added_at DateTime @default(now())

  user User @relation(fields: [user_id], references: [id])
  product Products @relation(fields: [product_id], references: [id])
  @@unique([user_id, product_id])
  @@index([user_id])
  @@index([product_id])
}

enum NotificationType {
  order
  payment
  promotion
  system
}

model Notifications {
  id Int @id @default(autoincrement())
  user_id Int?
  title String
  body String
  type NotificationType
  is_read Boolean @default(false)
  created_at DateTime @default(now())

  user User? @relation(fields: [user_id], references: [id])
  @@index([user_id])
}

model Banners {
  id Int @id @default(autoincrement())
  image_url String
  link_url String?
  sort_order Int @default(0)
  is_active Boolean @default(true)
  created_at DateTime @default(now())
}

enum ReTurnStatus {
  pending
  approved
  rejected
  received
  completed
}

model ReturnRequests {
  id Int @id @default(autoincrement())
  order_id Int
  user_id Int
  reason String
  status ReTurnStatus @default(pending)
  admin_note String?
  return_amount Decimal
  created_at DateTime @default(now())

  return_items ReturnItems[]
  return_images ReturnImages[]

  order Orders @relation(fields: [order_id], references: [id])
  user User @relation(fields: [user_id], references: [id])
  @@index([order_id])
  @@index([user_id])
}

enum ItemCondition {
  good
  damaged
  wrong_item
}

model ReturnItems {
  id Int @id @default(autoincrement())
  return_request_id Int
  order_item_id Int
  quantity Int
  condition ItemCondition

  return_request ReturnRequests @relation(fields: [return_request_id], references: [id])
  order_item OrderItems @relation(fields: [order_item_id], references: [id])
  @@index([return_request_id])
  @@index([order_item_id])
}

model ReturnImages {
  id Int @id @default(autoincrement())
  return_request_id Int
  image_url String

  return_request ReturnRequests @relation(fields: [return_request_id], references: [id])
  @@index([return_request_id])
}